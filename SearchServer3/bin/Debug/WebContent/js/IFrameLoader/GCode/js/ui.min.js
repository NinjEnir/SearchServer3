var GCODE={};GCODE.ui=function(){var e,r,o,t,n={first:0,last:0},s=!1,d={speed:1,expermm:2,volpersec:3},i=function(e,r){$("#"+e).width(parseInt(r)+"%").text(parseInt(r)+"%")},a=function(e){$("#"+e).collapse("show")},l=function(e){for(var o=n.first;o<n.last;o++)e?r.setLineClass(Number(o),null,"activeline"):r.setLineClass(Number(o),null,null)},u=function(e){var r,o=GCODE.renderer.getZ(e),t=GCODE.gCodeReader.getModelInfo().speedsByLayer,n=GCODE.renderer.getOptions(),s=n.colorLine,d=n.colorLineLen,i=0,a=[];for(a.push("Extrude speeds:"),r=0;r<t.extrude[o].length;r++)"undefined"!=typeof t.extrude[o][r]&&(i=r,i>d-1&&(i%=d-1),a.push("<div id='colorBox"+r+"' class='colorBox' style='background-color: "+s[i]+"'></div>  = "+(parseFloat(t.extrude[o][r])/60).toFixed(2)+"mm/s"));if("undefined"!=typeof t.move[o])for(a.push("Move speeds:"),r=0;r<t.move[o].length;r++)"undefined"!=typeof t.move[o][r]&&(i=r,i>d-1&&(i%=d-1),a.push("<div id='colorBox"+r+"' class='colorBox' style='background-color: "+n.colorMove+"'></div>  = "+(parseFloat(t.move[o][r])/60).toFixed(2)+"mm/s"));if("undefined"!=typeof t.retract[o])for(a.push("Retract speeds:"),r=0;r<t.retract[o].length;r++)"undefined"!=typeof t.retract[o][r]&&(i=r,i>d-1&&(i%=d-1),a.push("<span style='color: "+n.colorRetract+"'>&#9679;</span> <span style='color: "+n.colorRestart+"'>&#9679;</span> = "+(parseFloat(t.retract[o][r])/60).toFixed(2)+"mm/s"));return a},c=function(e){var r,o=GCODE.renderer.getZ(e),t=GCODE.gCodeReader.getModelInfo().volSpeedsByLayer,n=GCODE.renderer.getOptions(),s=n.colorLine,d=n.colorLineLen,i=0,a=[];for(a.push("Extrude speeds in extrusion mm per move mm:"),r=0;r<t[o].length;r++)"undefined"!=typeof t[o][r]&&(i=r,i>d-1&&(i%=d-1),a.push("<div id='colorBox"+r+"' class='colorBox' style='background-color: "+s[i]+"'></div>  = "+parseFloat(t[o][r]).toFixed(3)+"mm/mm"));return a},p=function(e){var r,o=GCODE.renderer.getZ(e),t=GCODE.gCodeReader.getModelInfo().extrusionSpeedsByLayer,n=GCODE.renderer.getOptions(),s=GCODE.gCodeReader.getOptions(),d=n.colorLine,i=n.colorLineLen,a=0,l=[];for(l.push("Extrude speeds in mm^3/sec:"),r=0;r<t[o].length;r++)"undefined"!=typeof t[o][r]&&(a=r,a>i-1&&(a%=i-1),l.push("<div id='colorBox"+r+"' class='colorBox' style='background-color: "+d[a]+"'></div>  = "+parseFloat(3.141*t[o][r]*s.filamentDia/10*s.filamentDia/10/4).toFixed(3)+"mm^3/sec"));return l},m=function(e){var r=GCODE.renderer.getZ(e),o=GCODE.renderer.getLayerNumSegments(e),t=GCODE.renderer.getOptions(),n=GCODE.gCodeReader.getLayerFilament(r),s=[];if(s.push("Layer number: "+e),s.push("Layer height (mm): "+r),s.push("GCODE commands in layer: "+o),s.push("Filament used by layer (mm): "+n.toFixed(2)),s.push("Print time for layer: "+parseFloat(GCODE.gCodeReader.getModelInfo().printTimeByLayer[r]).toFixed(1)+"sec"),t.speedDisplayType===d.speed){var i=u(e);s=s.concat(i)}else if(t.speedDisplayType===d.expermm){var i=c(e);s=s.concat(i)}else if(t.speedDisplayType===d.volpersec){var i=p(e);s=s.concat(i)}$("#layerInfo").html(s.join("<br>"))},g=function(){var o=window.location.hash.substr(1),t=o.split("#"),n=new XMLHttpRequest;n.open("GET",t[0],!0),n.responseType="blob",n.onload=function(){var o=this.response;e=new FileReader,e.onload=function(e){a("progressAccordionTab"),i("loadProgress",0),i("analyzeProgress",0),GCODE.gCodeReader.loadFile(e),r.setValue(e.target.result)},e.readAsText(o)},n.send()},C=function(){o=$("#slider-vertical"),t=$("#slider-horizontal");var e=function(e){var r=GCODE.renderer.getLayerNumSegments(e)-1;GCODE.renderer.render(e,0,r),t.slider({max:r,values:[0,r]}),l(!1),n=GCODE.gCodeReader.getGCodeLines(e,t.slider("values",0),t.slider("values",1)),l(!0),m(e)};o.slider({range:"min",min:0,max:GCODE.renderer.getModelNumLayers()-1,value:0,slide:function(r,o){e(o.value)}}),$("#slider-vertical").find(".ui-slider-handle").unbind("keydown"),t.slider({range:"min",min:0,max:GCODE.renderer.getLayerNumSegments(0)-1,values:[0,GCODE.renderer.getLayerNumSegments(0)-1],slide:function(e,r){l(!1),n=GCODE.gCodeReader.getGCodeLines(o.slider("value"),r.values[0],r.values[1]),l(!0),GCODE.renderer.render(o.slider("value"),r.values[0],r.values[1])}}),window.onkeydown=function(r){38===r.keyCode||33===r.keyCode?o.slider("value")<o.slider("option","max")&&(o.slider("value",o.slider("value")+1),e(o.slider("value"))):(40===r.keyCode||34===r.keyCode)&&o.slider("value")>0&&(o.slider("value",o.slider("value")-1),e(o.slider("value"))),r.stopPropagation()}},y=function(e){var r=e.data;switch(r.cmd){case"returnModel":i("loadProgress",100),GCODE.ui.worker.postMessage({cmd:"analyzeModel",msg:{}});break;case"analyzeDone":i("analyzeProgress",100),GCODE.gCodeReader.processAnalyzeModelDone(r.msg),GCODE.gCodeReader.passDataToRenderer(),C(),GCODE.ui.updateOptions(),$("#myTab").find('a[href="#tab2d"]').tab("show"),$("#runAnalysisButton").removeClass("disabled");break;case"returnLayer":GCODE.gCodeReader.processLayerFromWorker(r.msg),i("loadProgress",r.msg.progress);break;case"returnMultiLayer":GCODE.gCodeReader.processMultiLayerFromWorker(r.msg),i("loadProgress",r.msg.progress);break;case"analyzeProgress":i("analyzeProgress",r.msg.progress);break;default:console.log("default msg received"+r.cmd)}},h=function(){var e=[],r=[];return Modernizr.addTest("filereader",function(){return!!(window.File&&window.FileList&&window.FileReader)}),Modernizr.canvas||r.push("<li>Your browser doesn't seem to support HTML5 Canvas, this application won't work without it.</li>"),Modernizr.filereader||r.push("<li>Your browser doesn't seem to support HTML5 File API, this application won't work without it.</li>"),Modernizr.webworkers||r.push("<li>Your browser doesn't seem to support HTML5 Web Workers, this application won't work without it.</li>"),Modernizr.svg||r.push("<li>Your browser doesn't seem to support HTML5 SVG, this application won't work without it.</li>"),r.length>0?(document.getElementById("errorList").innerHTML="<ul>"+r.join("")+"</ul>",console.log("Initialization failed: unsupported browser."),!1):(Modernizr.webgl||(e.push("<li>Your browser doesn't seem to support HTML5 Web GL, 3d mode is not recommended, going to be SLOW!</li>"),GCODE.renderer3d.setOption({rendererType:"canvas"})),Modernizr.draganddrop||e.push("<li>Your browser doesn't seem to support HTML5 Drag'n'Drop, Drop area will not work.</li>"),e.length>0&&(document.getElementById("errorList").innerHTML="<ul>"+e.join("")+"</ul>",console.log("Initialization succeeded with warnings.")),!0)};return{worker:void 0,initHandlers:function(){var e=h();e&&(g(null),i("loadProgress",0),i("analyzeProgress",0),$("#myTab").find('a[href="#tab3d"]').click(function(e){e.preventDefault(),console.log("Switching to 3d mode"),$(this).tab("show"),GCODE.renderer3d.doRender()}),$("#myTab").find('a[href="#tabGCode"]').click(function(e){e.preventDefault(),$(this).tab("show"),r.refresh(),r.setCursor(Number(n.first),0),r.focus()}),this.worker=new Worker("js/Worker.js"),this.worker.addEventListener("message",y,!1),GCODE.renderer.render(0,0),GCODE.renderer3d.doRender(),r=new CodeMirror(document.getElementById("gCodeContainer"),{lineNumbers:!0,gutters:["CodeMirror-linenumbers"]}),r.setSize("700","350"),function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;window.requestAnimationFrame=e}(),$(".tab2d").tab("show"))},processOptions:function(){GCODE.gCodeReader.setOption(document.getElementById("sortLayersCheckbox").checked?{sortLayers:!0}:{sortLayers:!1}),GCODE.gCodeReader.setOption(document.getElementById("purgeEmptyLayersCheckbox").checked?{purgeEmptyLayers:!0}:{purgeEmptyLayers:!1}),s=document.getElementById("showGCodeCheckbox").checked,GCODE.renderer.setOption(document.getElementById("moveModelCheckbox").checked?{moveModel:!0}:{moveModel:!1}),GCODE.renderer.setOption(document.getElementById("showMovesCheckbox").checked?{showMoves:!0}:{showMoves:!1}),GCODE.renderer.setOption(document.getElementById("showRetractsCheckbox").checked?{showRetracts:!0}:{showRetracts:!1}),GCODE.renderer.setOption(document.getElementById("differentiateColorsCheckbox").checked?{differentiateColors:!0}:{differentiateColors:!1}),GCODE.renderer.setOption(document.getElementById("thickExtrusionCheckbox").checked?{actualWidth:!0}:{actualWidth:!1}),GCODE.renderer.setOption(document.getElementById("alphaCheckbox").checked?{alpha:!0}:{alpha:!1}),GCODE.renderer.setOption(document.getElementById("showNextLayer").checked?{showNextLayer:!0}:{showNextLayer:!1}),document.getElementById("renderErrors").checked?(GCODE.renderer.setOption({showMoves:!1}),GCODE.renderer.setOption({showRetracts:!1}),GCODE.renderer.setOption({renderAnalysis:!0}),GCODE.renderer.setOption({actualWidth:!0})):GCODE.renderer.setOption({renderAnalysis:!1});var e=1.75;Number($("#filamentDia").attr("value"))&&(e=Number($("#filamentDia").attr("value"))),GCODE.gCodeReader.setOption({filamentDia:e});var r=.4;Number($("#nozzleDia").attr("value"))&&(r=Number($("#nozzleDia").attr("value"))),GCODE.gCodeReader.setOption({nozzleDia:r}),document.getElementById("plasticABS").checked&&GCODE.gCodeReader.setOption({filamentType:"ABS"}),document.getElementById("plasticPLA").checked&&GCODE.gCodeReader.setOption({filamentType:"PLA"}),document.getElementById("speedDisplayRadio").checked&&GCODE.renderer.setOption({speedDisplayType:d.speed}),document.getElementById("exPerMMRadio").checked&&GCODE.renderer.setOption({speedDisplayType:d.expermm}),document.getElementById("volPerSecRadio").checked&&GCODE.renderer.setOption({speedDisplayType:d.volpersec})},updateOptions:function(){GCODE.gCodeReader.getOptions()},resetSliders:function(){},setOption:function(e){for(var r in e)uiOptions[r]=e[r]}}}();