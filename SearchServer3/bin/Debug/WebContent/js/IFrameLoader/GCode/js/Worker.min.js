var gcode,firstReport,z_heights={},model=[],gCodeOptions={sortLayers:!1,purgeEmptyLayers:!0,analyzeModel:!1},max={x:void 0,y:void 0,z:void 0},min={x:void 0,y:void 0,z:void 0},modelSize={x:void 0,y:void 0,z:void 0},filamentByLayer={},filamentByExtruder={},totalFilament=0,printTime=0,printTimeByLayer={},layerHeight=0,layerCnt=0,speeds={extrude:[],retract:[],move:[]},speedsByLayer={extrude:{},retract:{},move:{}},volSpeeds=[],volSpeedsByLayer={},extrusionSpeeds=[],extrusionSpeedsByLayer={},sendLayerToParent=function(e,r,a){self.postMessage({cmd:"returnLayer",msg:{cmds:model[e],layerNum:e,zHeightObject:{zValue:r,layer:z_heights[r]},isEmpty:!1,progress:a}})},sendMultiLayerToParent=function(e,r,a){for(var t=[],s={},o=0;o<e.length;o++)t[e[o]]=model[e[o]],s[e[o]]=z_heights[r[o]];self.postMessage({cmd:"returnMultiLayer",msg:{model:t,layerNum:e,zHeightObject:{zValue:r,layer:s},isEmpty:!1,progress:a}})},sendSizeProgress=function(e){self.postMessage({cmd:"analyzeProgress",msg:{progress:e,printTime:printTime}})},sendAnalyzeDone=function(){self.postMessage({cmd:"analyzeDone",msg:{max:max,min:min,modelSize:modelSize,totalFilament:totalFilament,filamentByLayer:filamentByLayer,filamentByExtruder:filamentByExtruder,printTime:printTime,layerHeight:layerHeight,layerCnt:layerCnt,layerTotal:model.length,speeds:speeds,speedsByLayer:speedsByLayer,volSpeeds:volSpeeds,volSpeedsByLayer:volSpeedsByLayer,printTimeByLayer:printTimeByLayer,extrusionSpeeds:extrusionSpeeds,extrusionSpeedsByLayer:extrusionSpeedsByLayer}})},purgeLayers=function(){for(var e=!0,r=0;r<model.length;r++){if(e=!0,model[r])for(var a=0;a<model[r].length;a++)model[r][a].extrude&&(e=!1);else e=!0;e||(layerCnt+=1)}},analyzeModel=function(){var e,r,a,t,s=!1,o=!1,d=0,i=0,n=0,p=0;for(e=0;e<model.length;e++)if(a=model[e]){for(r=0;r<a.length;r++)if(s=!1,o=!1,"undefined"!=typeof a[r].x&&"undefined"!=typeof a[r].prevX&&"undefined"!=typeof a[r].extrude&&a[r].extrude&&!isNaN(a[r].x)&&(max.x=parseFloat(parseFloat(max.x)>parseFloat(a[r].x)?max.x:a[r].x),max.x=parseFloat(parseFloat(max.x)>parseFloat(a[r].prevX)?max.x:a[r].prevX),min.x=parseFloat(parseFloat(min.x)<parseFloat(a[r].x)?min.x:a[r].x),min.x=parseFloat(parseFloat(min.x)<parseFloat(a[r].prevX)?min.x:a[r].prevX),s=!0),"undefined"!=typeof a[r].y&&"undefined"!=typeof a[r].prevY&&"undefined"!=typeof a[r].extrude&&a[r].extrude&&!isNaN(a[r].y)&&(max.y=parseFloat(parseFloat(max.y)>parseFloat(a[r].y)?max.y:a[r].y),max.y=parseFloat(parseFloat(max.y)>parseFloat(a[r].prevY)?max.y:a[r].prevY),min.y=parseFloat(parseFloat(min.y)<parseFloat(a[r].y)?min.y:a[r].y),min.y=parseFloat(parseFloat(min.y)<parseFloat(a[r].prevY)?min.y:a[r].prevY),o=!0),"undefined"!=typeof a[r].prevZ&&"undefined"!=typeof a[r].extrude&&a[r].extrude&&!isNaN(a[r].prevZ)&&(max.z=parseFloat(parseFloat(max.z)>parseFloat(a[r].prevZ)?max.z:a[r].prevZ),min.z=parseFloat(parseFloat(min.z)<parseFloat(a[r].prevZ)?min.z:a[r].prevZ)),("undefined"!=typeof a[r].extrude&&1==a[r].extrude||0!=a[r].retract)&&(totalFilament+=a[r].extrusion,filamentByLayer[a[r].prevZ]||(filamentByLayer[a[r].prevZ]=0),filamentByLayer[a[r].prevZ]+=a[r].extrusion,null!=a[r].extruder&&(filamentByExtruder[a[r].extruder]||(filamentByExtruder[a[r].extruder]=0),filamentByExtruder[a[r].extruder]+=a[r].extrusion)),s&&o?p=Math.sqrt(Math.pow(parseFloat(a[r].x)-parseFloat(a[r].prevX),2)+Math.pow(parseFloat(a[r].y)-parseFloat(a[r].prevY),2))/(a[r].speed/60):0===a[r].retract&&0!==a[r].extrusion?(d=Math.sqrt(Math.pow(parseFloat(a[r].x)-parseFloat(a[r].prevX),2)+Math.pow(parseFloat(a[r].y)-parseFloat(a[r].prevY),2))/(a[r].speed/60),i=Math.abs(parseFloat(a[r].extrusion)/(a[r].speed/60)),p=d>=i?d:i):0!==a[r].retract&&(p=Math.abs(parseFloat(a[r].extrusion)/(a[r].speed/60))),printTime+=p,"undefined"==typeof printTimeByLayer[a[r].prevZ]&&(printTimeByLayer[a[r].prevZ]=0),printTimeByLayer[a[r].prevZ]+=p,a[r].extrude&&0===a[r].retract?t="extrude":0!==a[r].retract?t="retract":a[r].extrude||0!==a[r].retract?(self.postMessage({cmd:"unknown type of move"}),t="unknown"):t="move",n=speeds[t].indexOf(a[r].speed),-1===n&&(speeds[t].push(a[r].speed),n=speeds[t].indexOf(a[r].speed)),"undefined"==typeof speedsByLayer[t][a[r].prevZ]&&(speedsByLayer[t][a[r].prevZ]=[]),-1===speedsByLayer[t][a[r].prevZ].indexOf(a[r].speed)&&(speedsByLayer[t][a[r].prevZ][n]=a[r].speed),a[r].extrude&&0===a[r].retract&&s&&o){var l=a[r].volPerMM;l=parseFloat(l).toFixed(3);var m=volSpeeds.indexOf(l);-1===m&&(volSpeeds.push(l),m=volSpeeds.indexOf(l)),"undefined"==typeof volSpeedsByLayer[a[r].prevZ]&&(volSpeedsByLayer[a[r].prevZ]=[]),-1===volSpeedsByLayer[a[r].prevZ].indexOf(l)&&(volSpeedsByLayer[a[r].prevZ][m]=l);var y=l*a[r].speed;y=parseFloat(y).toFixed(3);var m=extrusionSpeeds.indexOf(y);-1===m&&(extrusionSpeeds.push(y),m=extrusionSpeeds.indexOf(y)),"undefined"==typeof extrusionSpeedsByLayer[a[r].prevZ]&&(extrusionSpeedsByLayer[a[r].prevZ]=[]),-1===extrusionSpeedsByLayer[a[r].prevZ].indexOf(y)&&(extrusionSpeedsByLayer[a[r].prevZ][m]=y)}sendSizeProgress(e/model.length*100)}purgeLayers(),modelSize.x=Math.abs(max.x-min.x),modelSize.y=Math.abs(max.y-min.y),modelSize.z=Math.abs(max.z-min.z),layerHeight=(max.z-min.z)/(layerCnt-1),sendAnalyzeDone()},doParse=function(){var e,r;model=[];for(var a,t,s,o,d,i,n,p=void 0,l=0,m=[],y=[],u=0,x=new RegExp(/^(?:G0|G1)\s/i),v=(new RegExp,0),c=!1,f={e:0,a:0,b:0,c:0},g=0,h=0,F=0,z=4e3,b={a:void 0,b:void 0,c:void 0,e:void 0,abs:void 0},L=!1,B=!1,M=!1,S=0;S<gcode.length;S++){if(t=void 0,s=void 0,h=void 0,i=void 0,g=0,c=!1,n=null,b.abs=0,gcode[S]=gcode[S].split(/[\(;]/)[0],x.test(gcode[S])){var N=gcode[S].split(/\s/);for(a=0;a<N.length;a++)switch(e=N[a].charAt(0).toLowerCase()){case"x":t=N[a].slice(1);break;case"y":s=N[a].slice(1);break;case"z":if(h=N[a].slice(1),h=Number(h),h==F)continue;z_heights.hasOwnProperty(h)?v=z_heights[h]:(v=model.length,z_heights[h]=v),p=v,l=h,F=h;break;case"e":case"a":case"b":case"c":M=!0,n=e,r=parseFloat(N[a].slice(1)).toFixed(3),b.abs=L?parseFloat(r):parseFloat(r)-parseFloat(b[e]),c=b.abs>0,b.abs<0?(f[n]=-1,g=-1):0==b.abs?g=0:b.abs>0&&f[n]<0?(f[n]=0,g=1):g=0,b[e]=r;break;case"f":r=N[a].slice(1),z=r}B&&!M&&(c=!0,b.abs=Math.sqrt((o-t)*(o-t)+(d-s)*(d-s))),c&&0==g&&(i=Number(b.abs/Math.sqrt((o-t)*(o-t)+(d-s)*(d-s)))),model[v]||(model[v]=[]),model[v][model[v].length]={x:Number(t),y:Number(s),z:Number(h),extrude:c,retract:Number(g),noMove:!1,extrusion:c||g?Number(b.abs):0,extruder:n,prevX:Number(o),prevY:Number(d),prevZ:Number(F),speed:Number(z),gcodeLine:Number(S),volPerMM:"undefined"==typeof i?-1:i.toFixed(3)},"undefined"!=typeof t&&(o=t),"undefined"!=typeof s&&(d=s)}else if(gcode[S].match(/^(?:M82)/i))L=!1;else if(gcode[S].match(/^(?:G91)/i))L=!0;else if(gcode[S].match(/^(?:G90)/i))L=!1;else if(gcode[S].match(/^(?:M83)/i))L=!0;else if(gcode[S].match(/^(?:M101)/i))B=!0;else if(gcode[S].match(/^(?:M103)/i))B=!1;else if(gcode[S].match(/^(?:G92)/i)){var N=gcode[S].split(/\s/);for(a=0;a<N.length;a++)switch(e=N[a].charAt(0).toLowerCase()){case"x":t=N[a].slice(1);break;case"y":s=N[a].slice(1);break;case"z":h=N[a].slice(1),F=h;break;case"e":case"a":case"b":case"c":r=parseFloat(N[a].slice(1)).toFixed(3),n=e,b[e]=L?r:0}model[v]||(model[v]=[]),("undefined"!=typeof t||"undefined"!=typeof s||"undefined"!=typeof h)&&(model[v][model[v].length]={x:parseFloat(t),y:parseFloat(s),z:parseFloat(h),extrude:c,retract:parseFloat(g),noMove:!0,extrusion:0,extruder:n,prevX:parseFloat(o),prevY:parseFloat(d),prevZ:parseFloat(F),speed:parseFloat(z),gcodeLine:parseFloat(S)})}else if(gcode[S].match(/^(?:G28)/i)){var N=gcode[S].split(/\s/);for(a=0;a<N.length;a++)switch(e=N[a].charAt(0).toLowerCase()){case"x":t=N[a].slice(1);break;case"y":s=N[a].slice(1);break;case"z":if(h=N[a].slice(1),h=Number(h),h===F)continue;p=v,l=h,z_heights.hasOwnProperty(h)?v=z_heights[h]:(v=model.length,z_heights[h]=v),F=h}1==N.length,0==v&&"undefined"==typeof h&&(h=0,z_heights.hasOwnProperty(h)?v=z_heights[h]:(v=model.length,z_heights[h]=v),F=h),model[v]||(model[v]=[]),model[v][model[v].length]={x:Number(t),y:Number(s),z:Number(h),extrude:c,retract:Number(g),noMove:!1,extrusion:c||g?Number(b.abs):0,extruder:n,prevX:Number(o),prevY:Number(d),prevZ:Number(F),speed:Number(z),gcodeLine:Number(S)}}"undefined"!=typeof p&&(S-u>.02*gcode.length&&0!=m.length&&(u=S,sendMultiLayerToParent(m,y,S/gcode.length*100),m=[],y=[]),m[m.length]=p,y[y.length]=l,p=void 0,l=void 0)}sendMultiLayerToParent(m,y,S/gcode.length*100)},parseGCode=function(e){gcode=e.gcode,firstReport=e.options.firstReport,doParse(),gcode=[],self.postMessage({cmd:"returnModel",msg:{}})},runAnalyze=function(){analyzeModel(),model=[],z_heights=[],gcode=void 0,firstReport=void 0,z_heights={},model=[],max={x:void 0,y:void 0,z:void 0},min={x:void 0,y:void 0,z:void 0},modelSize={x:void 0,y:void 0,z:void 0},filamentByLayer={},filamentByExtruder={},totalFilament=0,printTime=0,printTimeByLayer={},layerHeight=0,layerCnt=0,speeds={extrude:[],retract:[],move:[]},speedsByLayer={extrude:{},retract:{},move:{}}},setOption=function(e){for(var r in e)gCodeOptions[r]=e[r]};onmessage=function(e){var r=e.data;switch(r.cmd){case"parseGCode":parseGCode(r.msg);break;case"setOption":setOption(r.msg);break;case"analyzeModel":runAnalyze(r.msg);break;default:self.postMessage("Unknown command: "+r.msg)}};