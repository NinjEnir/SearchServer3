GCODE.renderer=function(){function e(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=t.createSVGMatrix();e.getTransform=function(){return r};var o=[],n=e.save;e.save=function(){return o.push(r.translate(0,0)),n.call(e)};var a=e.restore;e.restore=function(){return r=o.pop(),a.call(e)};var i=e.scale;e.scale=function(t,o){return r=r.scaleNonUniform(t,o),i.call(e,t,o)};var s=e.rotate;e.rotate=function(t){return r=r.rotate(180*t/Math.PI),s.call(e,t)};var l=e.translate;e.translate=function(t,o){return r=r.translate(t,o),l.call(e,t,o)};var d=e.transform;e.transform=function(o,n,a,i,s,l){var f=t.createSVGMatrix();return f.a=o,f.b=n,f.c=a,f.d=i,f.e=s,f.f=l,r=r.multiply(f),d.call(e,o,n,a,i,s,l)};var f=e.setTransform;e.setTransform=function(t,o,n,a,i,s){return r.a=t,r.b=o,r.c=n,r.d=a,r.e=i,r.f=s,f.call(e,t,o,n,a,i,s)};var c=t.createSVGPoint();e.transformedPoint=function(e,t){return c.x=e,c.y=t,c.matrixTransform(r.inverse())}}var t,r,o,n,a,i,s,l,d,f,c=3,u=.4,p=200,y=200,h=10,v=0,m=0,g={from:0,to:-1},x=1.1,S=!1,w={speed:1,expermm:2,volpersec:3},L={showMoves:!0,showRetracts:!0,colorGrid:"#bbbbbb",extrusionWidth:1,colorLine:["#000000","#45c7ba","#a9533a","#ff44cc","#dd1177","#eeee22","#ffbb55","#ff5511","#777788","#ff0000","#ffff00"],colorLineLen:9,colorMove:"#00ff00",colorRetract:"#ff0000",colorRestart:"#0000ff",sizeRetractSpot:2,modelCenter:{x:0,y:0},moveModel:!0,differentiateColors:!0,showNextLayer:!1,alpha:!1,actualWidth:!1,renderErrors:!1,renderAnalysis:!1,speedDisplayType:w.speed},b=0,C=0,T=[],M={},P=[],D={},R=[],E={},N=function(){var e=GCODE.gCodeReader.getOptions(),o=r.transformedPoint(0,0),n=r.transformedPoint(t.width,t.height);r.clearRect(o.x,o.y,n.x-o.x,n.y-o.y),k(),r.globalAlpha=L.alpha?.6:1,L.extrusionWidth=L.actualWidth?e.filamentDia*e.wh/c:e.filamentDia*e.wh/c/2,L.showNextLayer&&a<f.length-1&&G(a+1,0,GCODE.renderer.getLayerNumSegments(a+1),!0),G(a,g.from,g.to)},O=function(){if(t=document.getElementById("canvas"),!t.getContext)throw"exception";r=t.getContext("2d"),o=t.height,n=t.width,i=n/2,s=o/2,r.lineWidth=2,r.lineCap="round",e(r),t.addEventListener("mousedown",function(e){document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",i=e.offsetX||e.pageX-t.offsetLeft,s=e.offsetY||e.pageY-t.offsetTop,l=r.transformedPoint(i,s),d=!1},!1),t.addEventListener("mousemove",function(e){if(i=e.offsetX||e.pageX-t.offsetLeft,s=e.offsetY||e.pageY-t.offsetTop,d=!0,l){var o=r.transformedPoint(i,s);r.translate(o.x-l.x,o.y-l.y),N()}},!1),t.addEventListener("mouseup",function(e){l=null,d||a(e.shiftKey?-1:1)},!1);var a=function(e){var t=r.transformedPoint(i,s);r.translate(t.x,t.y);var o=Math.pow(x,e);r.scale(o,o),r.translate(-t.x,-t.y),N()},f=function(e){var t;return t=e.detail<0||e.wheelDelta>0?u:-1*u,t&&a(t),e.preventDefault()&&!1};t.addEventListener("DOMMouseScroll",f,!1),t.addEventListener("mousewheel",f,!1)},k=function(){var e;r.strokeStyle=L.colorGrid,r.lineWidth=1;var t=0,o=0;for(L.moveModel&&(t=b,o=C),r.beginPath(),e=0;p>=e;e+=h)r.moveTo(e*c-t,0-o),r.lineTo(e*c-t,-y*c-o);for(r.stroke(),r.beginPath(),e=0;y>=e;e+=h)r.moveTo(0-t,-e*c-o),r.lineTo(p*c-t,-e*c-o);r.stroke()},G=function(e,t,o,n){var i,s=0,l=0;if(n="undefined"!=typeof n?n:!1,n||(a=e,g={from:t,to:o}),f&&f[e]){var d,u,p=f[e];if(t>0)v=p[t-1].x*c,m=-p[t-1].y*c;else if(0===t&&0==e)f[0]&&"undefined"!=typeof f[0].x&&"undefined"!=typeof f[0].y?(v=f[0].x*c,m=-f[0].y*c):(v=0,m=0);else if("undefined"!=typeof p[0].prevX&&"undefined"!=typeof p[0].prevY)v=p[0].prevX*c,m=-p[0].prevY*c;else if(f[e-1]){for(v=void 0,m=void 0,i=f[e-1].length-1;i>=0;i--)"undefined"==typeof v&&void 0!==f[e-1][i].x&&(v=f[e-1][i].x*c),"undefined"==typeof m&&void 0!==f[e-1][i].y&&(m=-f[e-1][i].y*c);"undefined"==typeof v&&(v=0),"undefined"==typeof m&&(m=0)}else v=0,m=0;for(l=GCODE.renderer.getZ(e),i=t;o>=i;i++)if(r.lineWidth=1,"undefined"!=typeof p[i]){if("undefined"!=typeof p[i].prevX&&"undefined"!=typeof p[i].prevY&&(v=p[i].prevX*c,m=-p[i].prevY*c),d="undefined"==typeof p[i].x||isNaN(p[i].x)?v/c:p[i].x,u="undefined"==typeof p[i].y||isNaN(p[i].y)?m/c:-p[i].y,!L.differentiateColors||L.showNextLayer||L.renderAnalysis?s=L.showNextLayer&&n?3:L.renderErrors?2===p[i].errType?9:1===p[i].errType?10:0:L.renderAnalysis&&0!==e?-1:0:(s=L.speedDisplayType===w.speed?T.extrude.indexOf(p[i].speed):L.speedDisplayType===w.expermm?P.indexOf(p[i].volPerMM):L.speedDisplayType===w.volpersec?R.indexOf((p[i].volPerMM*p[i].speed).toFixed(3)):0,-1===s?s=0:s>L.colorLineLen-1&&(s%=L.colorLineLen-1)),p[i].extrude||p[i].noMove){if(p[i].extrude)if(0==p[i].retract){if(s>=0)r.strokeStyle=L.colorLine[s];else if(-1===s){var y=parseInt(p[i].errLevelB).toString(16),h="#"+"00".substr(0,2-y.length)+y+"0000";y=parseInt(p[i].errLevelE).toString(16);var x="#"+"00".substr(0,2-y.length)+y+"0000",S=r.createLinearGradient(v,m,d*c,u*c);if(1===p[i].errType){var b=1-p[i].errDelimiter;b>=.99&&(b=.99),S.addColorStop(0,"#000000"),S.addColorStop(b,"#000000"),S.addColorStop(b+.01,x),S.addColorStop(1,x)}else if(2===p[i].errType){S.addColorStop(0,h);var b=p[i].errDelimiter;b>=.99&&(b=.99),S.addColorStop(b,h),S.addColorStop(b+.01,"#000000"),S.addColorStop(1,"#000000")}else S.addColorStop(0,h),S.addColorStop(1,x);r.strokeStyle=S}r.lineWidth=L.extrusionWidth,r.beginPath(),r.moveTo(v,m),r.lineTo(d*c,u*c),r.stroke()}else L.showRetracts&&(r.strokeStyle=L.colorRestart,r.fillStyle=L.colorRestart,r.beginPath(),r.arc(v,m,L.sizeRetractSpot,0,2*Math.PI,!0),r.stroke(),r.fill())}else-1==p[i].retract&&L.showRetracts&&(r.strokeStyle=L.colorRetract,r.fillStyle=L.colorRetract,r.beginPath(),r.arc(v,m,L.sizeRetractSpot,0,2*Math.PI,!0),r.stroke(),r.fill()),L.showMoves&&(r.strokeStyle=L.colorMove,r.beginPath(),r.moveTo(v,m),r.lineTo(d*c,u*c),r.stroke());v=d*c,m=u*c}r.stroke()}};return{init:function(){O(),S=!0,r.translate((t.width-p*c)/2,y*c+(t.height-y*c)/2)},setOption:function(e){for(var t in e)e.hasOwnProperty(t)&&(L[t]=e[t]);S&&N()},getOptions:function(){return L},debugGetModel:function(){return f},render:function(e,o,n){var a=GCODE.gCodeReader.getOptions();if(S||this.init(),f)if(e<f.length){var i=r.transformedPoint(0,0),s=r.transformedPoint(t.width,t.height);r.clearRect(i.x,i.y,s.x-i.x,s.y-i.y),k(),r.globalAlpha=L.alpha?.6:1,L.extrusionWidth=L.actualWidth?a.filamentDia*a.wh/c:a.filamentDia*a.wh/c/2,L.showNextLayer&&e<f.length-1&&G(e+1,0,this.getLayerNumSegments(e+1),!0),G(e,o,n)}else console.log("Got request to render non-existent layer!!");else k()},getModelNumLayers:function(){return f?f.length:1},getLayerNumSegments:function(e){return f&&f[e]?f[e].length:1},doRender:function(e,o){var n;f=e,v=0,m=0,S||this.init(),n=GCODE.gCodeReader.getModelInfo(),T=n.speeds,M=n.speedsByLayer,P=n.volSpeeds,D=n.volSpeedsByLayer,R=n.extrusionSpeeds,E=n.extrusionSpeedsByLayer,b=(p/2-(n.min.x+n.modelSize.x/2))*c,C=(n.min.y+n.modelSize.y/2)*c-y/2*c,r&&r.translate(b,C);var a=n.modelSize.x>n.modelSize.y?t.width/n.modelSize.x/c:t.height/n.modelSize.y/c,i=r.transformedPoint(t.width/2,t.height/2),s=r.getTransform(),l=a/s.a,d=a/s.d;r.translate(i.x,i.y),r.scale(.98*l,.98*d),r.translate(-i.x,-i.y),this.render(o,0,f[o].length)},getZ:function(e){if(!f&&!f[e])return"-1";for(var t=f[e],r=0;r<t.length;r++)if(void 0!==t[r].prevZ)return t[r].prevZ;return"-1"}}}();